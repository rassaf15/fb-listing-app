<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FB Listing">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè™</text></svg>">
    <title>FB Marketplace Listing Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            min-height: 100vh;
            background: white;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header h1 {
            font-size: 20px;
            flex: 1;
            text-align: center;
        }
        
        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .settings-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .history-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .history-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .content {
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal.active {
            display: block;
        }
        
        .modal-content {
            background: white;
            margin: 20px;
            border-radius: 16px;
            padding: 20px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 60px;
            margin-bottom: 60px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .modal-header h2 {
            font-size: 20px;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:active {
            background: #f0f0f0;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-group small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .input-group small a {
            color: #667eea;
            text-decoration: none;
        }
        
        .save-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .save-btn:active {
            opacity: 0.8;
        }
        
        .setup-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .setup-notice h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .setup-notice p {
            color: #856404;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .setup-notice button {
            background: #ffc107;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .setup-notice button:active {
            opacity: 0.8;
        }
        
        .photo-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .photo-btn {
            padding: 16px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .photo-btn:active {
            background: #f0f2ff;
        }
        
        .photo-btn .icon {
            font-size: 32px;
        }
        
        #cameraInput,
        #galleryInput {
            display: none;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.95);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .manual-input-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .manual-input-section h3 {
            font-size: 16px;
            color: #495057;
            margin-bottom: 15px;
        }
        
        .manual-inputs {
            display: grid;
            gap: 15px;
        }
        
        .manual-inputs input,
        .manual-inputs textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .manual-inputs textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .review-section {
            background: #e8f4fd;
            border: 2px solid #0288d1;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .review-section.active {
            display: block;
        }
        
        .review-section h3 {
            color: #01579b;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .detected-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .detected-info strong {
            color: #01579b;
        }
        
        .uncertain-info {
            background: #fff9e6;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .uncertain-info strong {
            color: #f57c00;
        }
        
        .review-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .review-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .review-btn.edit {
            background: #ff9800;
            color: white;
        }
        
        .review-btn.continue {
            background: #4caf50;
            color: white;
        }
        
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .edit-modal.active {
            display: block;
        }
        
        .edit-modal-content {
            background: white;
            margin: 20px;
            border-radius: 16px;
            padding: 20px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 60px;
            margin-bottom: 60px;
        }
        
        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .edit-modal-header h2 {
            font-size: 20px;
            color: #333;
        }
        
        .edit-form-section {
            margin-bottom: 25px;
        }
        
        .edit-form-section h3 {
            font-size: 16px;
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .edit-form-group {
            margin-bottom: 15px;
        }
        
        .edit-form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 6px;
        }
        
        .edit-form-group input,
        .edit-form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .edit-form-group textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        
        .edit-form-group small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-size: 12px;
        }
        
        .update-btn {
            width: 100%;
            padding: 14px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .update-btn:active {
            opacity: 0.8;
        }
        
        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .generate-btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-steps {
            color: #6c757d;
            font-size: 15px;
            line-height: 2;
        }
        
        .loading-steps .step {
            opacity: 0.4;
            transition: opacity 0.3s;
        }
        
        .loading-steps .step.active {
            opacity: 1;
            color: #667eea;
            font-weight: 600;
        }
        
        .loading-steps .step.complete {
            opacity: 0.7;
            color: #28a745;
        }
        
        .results {
            display: none;
        }
        
        .results.active {
            display: block;
        }
        
        .result-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .result-section h3 {
            font-size: 16px;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            position: relative;
        }
        
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            z-index: 10;
        }
        
        .copy-btn:active {
            background: #5568d3;
        }
        
        .copy-btn.copied {
            background: #28a745;
        }
        
        .title-preview {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            line-height: 1.5;
            padding-right: 80px;
        }
        
        .description-preview {
            white-space: pre-wrap;
            line-height: 1.7;
            color: #495057;
            font-size: 14px;
            padding-right: 80px;
        }
        
        .pricing-grid {
            display: grid;
            gap: 15px;
        }
        
        .price-summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .price-summary h4 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .price-range {
            font-size: 28px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 8px;
        }
        
        .sweet-spot {
            font-size: 16px;
            color: #28a745;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .price-note {
            font-size: 13px;
            color: #6c757d;
            line-height: 1.5;
        }
        
        .comparables {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }
        
        .comparables h4 {
            font-size: 14px;
            color: #495057;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .comparable-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .comparable-item:last-child {
            margin-bottom: 0;
        }
        
        .comparable-price {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .comparable-details {
            color: #6c757d;
            font-size: 12px;
        }
        
        .market-insights {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.7;
            color: #495057;
        }
        
        .quality-checks {
            display: grid;
            gap: 12px;
        }
        
        .quality-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #e0e0e0;
        }
        
        .quality-item.warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        
        .quality-item.success {
            border-left-color: #28a745;
            background: #f0fff4;
        }
        
        .quality-item.info {
            border-left-color: #17a2b8;
            background: #f0f9ff;
        }
        
        .quality-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .quality-text {
            font-size: 14px;
            color: #495057;
            line-height: 1.6;
        }
        
        .error-message {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .error-message.active {
            display: block;
        }
        
        .new-listing-btn {
            width: 100%;
            padding: 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .new-listing-btn:active {
            opacity: 0.8;
        }
        
        .history-list {
            display: grid;
            gap: 15px;
        }
        
        .history-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
        }
        
        .history-item:active {
            background: #f8f9fa;
        }
        
        .history-title {
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .history-date {
            color: #6c757d;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .history-price {
            color: #667eea;
            font-weight: 600;
            font-size: 16px;
        }
        
        .empty-history {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-history .icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 600px;
                margin: 0 auto;
                border-radius: 16px;
                overflow: hidden;
                min-height: auto;
            }
            
            body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <button class="history-btn" onclick="openHistory()">üìã</button>
<h1>üè™ FB Listing v4.2</h1>
                <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
        </div>
        
        <div class="content">
            <div class="setup-notice" id="setupNotice" style="display: none;">
                <h3>‚ö†Ô∏è Setup Required</h3>
                <p>Please configure your API keys to start creating listings</p>
                <button onclick="openSettings()">Open Settings</button>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <div id="mainContent" style="display: none;">
                <div class="photo-actions">
                    <button class="photo-btn" onclick="document.getElementById('cameraInput').click()">
                        <span class="icon">üì∑</span>
                        <span>Camera</span>
                    </button>
                    <button class="photo-btn" onclick="document.getElementById('galleryInput').click()">
                        <span class="icon">üñºÔ∏è</span>
                        <span>Gallery</span>
                    </button>
                </div>
                
                <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
                <input type="file" id="galleryInput" accept="image/*" multiple>
                
                <div class="preview-grid" id="previewGrid"></div>
                
                <div class="manual-input-section">
                    <h3>üìù Optional Product Details</h3>
                    <div class="manual-inputs">
                        <input type="text" id="brandInput" placeholder="Brand (e.g., Sony, Apple)">
                        <input type="text" id="modelInput" placeholder="Model (e.g., PlayStation 5)">
                        <input type="text" id="conditionInput" placeholder="Condition (e.g., Like New)">
                        <textarea id="additionalInfo" placeholder="Additional info (original box, accessories, etc.)"></textarea>
                    </div>
                </div>
                
                <div class="review-section" id="reviewSection">
                    <h3>üîç Please Review Detection</h3>
                    <div class="detected-info" id="detectedInfo"></div>
                    <div class="uncertain-info" id="uncertainInfo" style="display: none;"></div>
                    <div class="review-actions">
                        <button class="review-btn edit" onclick="openEditModal()">‚úèÔ∏è Edit Details</button>
                        <button class="review-btn continue" onclick="continueToGenerate()">‚úÖ Looks Good</button>
                    </div>
                </div>
                
                <!-- Edit Modal -->
                <div class="edit-modal" id="editModal">
                    <div class="edit-modal-content">
                        <div class="edit-modal-header">
                            <h2>‚úèÔ∏è Edit Product Details</h2>
                            <button class="close-btn" onclick="closeEditModal()">√ó</button>
                        </div>
                        
                        <div class="edit-form-section">
                            <h3>Product Information</h3>
                            <div class="edit-form-group">
                                <label>Brand</label>
                                <input type="text" id="editBrand" placeholder="e.g., Sony, Apple, Samsung">
                                <small>Leave blank if already detected correctly</small>
                            </div>
                            <div class="edit-form-group">
                                <label>Model</label>
                                <input type="text" id="editModel" placeholder="e.g., PlayStation 5, iPhone 14">
                                <small>Leave blank if already detected correctly</small>
                            </div>
                            <div class="edit-form-group">
                                <label>Year / Release Date</label>
                                <input type="text" id="editYear" placeholder="e.g., 2020, 2021-2022">
                                <small>Optional - will be researched automatically if left blank</small>
                            </div>
                        </div>
                        
                        <div class="edit-form-section">
                            <h3>Condition & Contents</h3>
                            <div class="edit-form-group">
                                <label>Condition</label>
                                <input type="text" id="editCondition" placeholder="e.g., Like New, Excellent, Good">
                                <small>Assumed to be good working condition unless specified</small>
                            </div>
                            <div class="edit-form-group">
                                <label>What's Included (Accessories)</label>
                                <textarea id="editAccessories" placeholder="e.g., Original box, all cables, manual, remote control"></textarea>
                                <small>List everything included with this item</small>
                            </div>
                        </div>
                        
                        <div class="edit-form-section">
                            <h3>Additional Information</h3>
                            <div class="edit-form-group">
                                <label>Dimensions / Size</label>
                                <input type="text" id="editDimensions" placeholder="e.g., 10 x 8 x 5 inches">
                                <small>Optional - will be looked up automatically if available</small>
                            </div>
                            <div class="edit-form-group">
                                <label>Other Notes</label>
                                <textarea id="editNotes" placeholder="Any other important details, defects, or special features"></textarea>
                            </div>
                        </div>
                        
                        <button class="update-btn" onclick="updateDetection()">‚úì Update & Review</button>
                    </div>
                </div>
                
                <button class="generate-btn" id="analyzeBtn" onclick="analyzeProduct()" disabled>
                    üîç Analyze Product
                </button>
            </div>
            
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <div class="loading-steps">
                    <div class="step" id="step1">üì∏ Analyzing images...</div>
                    <div class="step" id="step2">üîç Researching eBay prices...</div>
                    <div class="step" id="step3">üí∞ Analyzing local market...</div>
                    <div class="step" id="step4">‚úçÔ∏è Generating listing...</div>
                    <div class="step" id="step5">‚úÖ Finalizing...</div>
                </div>
            </div>
            
            <div class="results" id="resultsSection">
                <button class="new-listing-btn" onclick="startNewListing()">‚ûï Create New Listing</button>
                
                <div class="result-section">
                    <h3>üìå Title</h3>
                    <div class="result-content">
                        <button class="copy-btn" onclick="copyToClipboard('titleText', event)">Copy</button>
                        <div class="title-preview" id="titleText"></div>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3>üìÑ Description</h3>
                    <div class="result-content">
                        <button class="copy-btn" onclick="copyToClipboard('descriptionText', event)">Copy</button>
                        <div class="description-preview" id="descriptionText"></div>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3>üí∞ Pricing Research</h3>
                    <div class="result-content">
                        <div class="pricing-grid">
                            <div class="price-summary" id="priceSummary"></div>
                            <div class="comparables" id="comparables"></div>
                            <div class="market-insights" id="marketInsights"></div>
                        </div>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3>‚úì Quality Checks</h3>
                    <div class="result-content">
                        <div class="quality-checks" id="qualityChecks"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è API Settings</h2>
                <button class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            
            <div class="input-group">
                <label>OpenAI API Key</label>
                <input type="password" id="openaiKey" placeholder="sk-...">
                <small>For image recognition<br><a href="https://platform.openai.com/api-keys" target="_blank">Get your key ‚Üí</a></small>
            </div>
            
            <div class="input-group">
                <label>Anthropic API Key</label>
                <input type="password" id="anthropicKey" placeholder="sk-ant-...">
                <small>For listing generation<br><a href="https://console.anthropic.com/" target="_blank">Get your key ‚Üí</a></small>
            </div>
            
            <div class="input-group">
                <label>eBay App ID (Client ID)</label>
                <input type="text" id="ebayKey" placeholder="YourAppI-...">
                <small>For accurate pricing data<br><a href="https://developer.ebay.com/my/keys" target="_blank">Get your key ‚Üí</a><br>
                Steps: Create account ‚Üí Application Keys ‚Üí Get Production keys ‚Üí Copy "App ID (Client ID)"</small>
            </div>
            
            <button class="save-btn" onclick="saveSettings()">üíæ Save Settings</button>
        </div>
    </div>
    
    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Listing History</h2>
                <button class="close-btn" onclick="closeHistory()">√ó</button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let detectionResult = null;
        let currentListing = null;
        let userEdits = {
            brand: '',
            model: '',
            year: '',
            condition: '',
            accessories: '',
            dimensions: '',
            notes: ''
        };
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            checkSetup();
            loadHistory();
            
            document.getElementById('cameraInput').addEventListener('change', (e) => handleFiles(e.target.files));
            document.getElementById('galleryInput').addEventListener('change', (e) => handleFiles(e.target.files));
        });
        
        function checkSetup() {
            const openaiKey = localStorage.getItem('openai_key');
            const anthropicKey = localStorage.getItem('anthropic_key');
            const ebayKey = localStorage.getItem('ebay_key');
            
            if (!openaiKey || !anthropicKey || !ebayKey) {
                document.getElementById('setupNotice').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
            } else {
                document.getElementById('setupNotice').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }
        }
        
        function openSettings() {
            document.getElementById('openaiKey').value = localStorage.getItem('openai_key') || '';
            document.getElementById('anthropicKey').value = localStorage.getItem('anthropic_key') || '';
            document.getElementById('ebayKey').value = localStorage.getItem('ebay_key') || '';
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        
        function saveSettings() {
            const openaiKey = document.getElementById('openaiKey').value.trim();
            const anthropicKey = document.getElementById('anthropicKey').value.trim();
            const ebayKey = document.getElementById('ebayKey').value.trim();
            
            if (!openaiKey || !anthropicKey || !ebayKey) {
                showError('Please fill in all API keys');
                return;
            }
            
            localStorage.setItem('openai_key', openaiKey);
            localStorage.setItem('anthropic_key', anthropicKey);
            localStorage.setItem('ebay_key', ebayKey);
            
            closeSettings();
            checkSetup();
            showError('‚úÖ Settings saved!');
        }
        
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    uploadedFiles.push(file);
                    displayPreview(file);
                }
            });
            updateAnalyzeButton();
        }
        
        function displayPreview(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button class="remove-btn" onclick="removeImage(${uploadedFiles.length - 1})">√ó</button>
                `;
                document.getElementById('previewGrid').appendChild(div);
            };
            reader.readAsDataURL(file);
        }
        
        function removeImage(index) {
            uploadedFiles.splice(index, 1);
            document.getElementById('previewGrid').innerHTML = '';
            uploadedFiles.forEach(file => displayPreview(file));
            updateAnalyzeButton();
        }
        
        function updateAnalyzeButton() {
            document.getElementById('analyzeBtn').disabled = uploadedFiles.length === 0;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            setTimeout(() => {
                errorDiv.classList.remove('active');
            }, 5000);
        }
        
        function updateLoadingStep(stepNum) {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                if (i < stepNum) {
                    step.className = 'step complete';
                } else if (i === stepNum) {
                    step.className = 'step active';
                } else {
                    step.className = 'step';
                }
            }
        }
        
        async function analyzeProduct() {
            if (uploadedFiles.length === 0) {
                showError('Please add at least one photo');
                return;
            }
            
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            
            try {
                updateLoadingStep(1);
                const openaiKey = localStorage.getItem('openai_key');
                detectionResult = await analyzeImagesWithGPT(uploadedFiles, openaiKey);
                
                // Show review section
                document.getElementById('loadingSection').classList.remove('active');
                document.getElementById('mainContent').style.display = 'block';
                displayReview(detectionResult);
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Error analyzing images: ${error.message}`);
                document.getElementById('loadingSection').classList.remove('active');
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('analyzeBtn').disabled = false;
            }
        }
        
        function displayReview(analysis) {
            const reviewSection = document.getElementById('reviewSection');
            const detectedInfo = document.getElementById('detectedInfo');
            const uncertainInfo = document.getElementById('uncertainInfo');
            
            // Parse analysis to find confident and uncertain info
            const lines = analysis.split('\n');
            let confident = [];
            let uncertain = [];
            
            lines.forEach(line => {
                if (line.toLowerCase().includes('uncertain') || 
                    line.toLowerCase().includes('not sure') || 
                    line.toLowerCase().includes('unable to determine') ||
                    line.toLowerCase().includes('cannot confirm')) {
                    uncertain.push(line);
                } else if (line.trim()) {
                    confident.push(line);
                }
            });
            
            detectedInfo.innerHTML = `<strong>Detected Information:</strong><br>${confident.join('<br>')}`;
            
            if (uncertain.length > 0) {
                uncertainInfo.innerHTML = `<strong>‚ö†Ô∏è Needs Verification:</strong><br>${uncertain.join('<br>')}<br><br><em>Click "Edit Details" to provide missing information, or click "Looks Good" to proceed with automatic research.</em>`;
                uncertainInfo.style.display = 'block';
            } else {
                uncertainInfo.style.display = 'none';
            }
            
            // Pre-populate edit form with any manual input already provided
            document.getElementById('editBrand').value = document.getElementById('brandInput').value.trim();
            document.getElementById('editModel').value = document.getElementById('modelInput').value.trim();
            document.getElementById('editCondition').value = document.getElementById('conditionInput').value.trim();
            document.getElementById('editNotes').value = document.getElementById('additionalInfo').value.trim();
            
            reviewSection.classList.add('active');
            reviewSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function openEditModal() {
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        
        function updateDetection() {
            // Save user edits
            userEdits.brand = document.getElementById('editBrand').value.trim();
            userEdits.model = document.getElementById('editModel').value.trim();
            userEdits.year = document.getElementById('editYear').value.trim();
            userEdits.condition = document.getElementById('editCondition').value.trim();
            userEdits.accessories = document.getElementById('editAccessories').value.trim();
            userEdits.dimensions = document.getElementById('editDimensions').value.trim();
            userEdits.notes = document.getElementById('editNotes').value.trim();
            
            // Update the detection display with user inputs
            let updatedInfo = detectionResult;
            
            // Append user edits to detection info
            const detectedInfo = document.getElementById('detectedInfo');
            let displayText = `<strong>Product Information:</strong><br>`;
            
            if (userEdits.brand) displayText += `Brand: ${userEdits.brand}<br>`;
            if (userEdits.model) displayText += `Model: ${userEdits.model}<br>`;
            if (userEdits.year) displayText += `Year: ${userEdits.year}<br>`;
            if (userEdits.condition) displayText += `Condition: ${userEdits.condition}<br>`;
            if (userEdits.accessories) displayText += `Included: ${userEdits.accessories}<br>`;
            if (userEdits.dimensions) displayText += `Dimensions: ${userEdits.dimensions}<br>`;
            if (userEdits.notes) displayText += `Notes: ${userEdits.notes}<br>`;
            
            displayText += `<br><strong>From Images:</strong><br>${detectionResult}`;
            
            detectedInfo.innerHTML = displayText;
            
            // Clear uncertainties since user provided info
            document.getElementById('uncertainInfo').style.display = 'none';
            
            closeEditModal();
            
            // Scroll back to review
            document.getElementById('reviewSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        async function continueToGenerate() {
            document.getElementById('reviewSection').classList.remove('active');
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('mainContent').style.display = 'none';
            
            try {
                // Merge user edits with manual info
                const manualInfo = {
                    brand: userEdits.brand || document.getElementById('brandInput').value.trim(),
                    model: userEdits.model || document.getElementById('modelInput').value.trim(),
                    year: userEdits.year,
                    condition: userEdits.condition || document.getElementById('conditionInput').value.trim() || 'Good working condition',
                    accessories: userEdits.accessories,
                    dimensions: userEdits.dimensions,
                    additional: userEdits.notes || document.getElementById('additionalInfo').value.trim()
                };
                
                updateLoadingStep(2);
                const ebayKey = localStorage.getItem('ebay_key');
                const ebayData = await fetchEbayPricing(detectionResult, manualInfo, ebayKey);
                
                updateLoadingStep(3);
                updateLoadingStep(4);
                const anthropicKey = localStorage.getItem('anthropic_key');
                currentListing = await generateListingWithClaude(detectionResult, manualInfo, ebayData, anthropicKey);
                
                updateLoadingStep(5);
                displayResults(currentListing);
                
                // Save to history
                saveToHistory(currentListing);
                
                setTimeout(() => {
                    document.getElementById('loadingSection').classList.remove('active');
                    document.getElementById('resultsSection').classList.add('active');
                }, 500);
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Error generating listing: ${error.message}`);
                document.getElementById('loadingSection').classList.remove('active');
                document.getElementById('mainContent').style.display = 'block';
            }
        }
        
        async function analyzeImagesWithGPT(files, apiKey) {
            const imagePromises = files.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });
            
            const base64Images = await Promise.all(imagePromises);
            
            const messages = [{
                role: "user",
                content: [
                    {
                        type: "text",
                        text: `Analyze these product photos for a Facebook Marketplace listing in Ottawa, Canada. Provide:

1. **Product Identification** (be as specific as possible):
   - Brand and model number
   - Product type/category
   - Any visible specifications (storage, capacity, size, color, year)

2. **Condition Assessment**:
   - Overall condition (excellent, good, fair)
   - Any visible wear, scratches, damage, or defects
   - Completeness (missing parts, buttons, components)

3. **Visible Information**:
   - Labels, model numbers, serial numbers (read any text clearly)
   - Accessories visible in photos
   - Original packaging visible
   - Size/dimensions if reference objects present

4. **DO NOT ASSESS**:
   - Functionality or working condition (assume it works)
   - Year if not explicitly visible (will be researched automatically)
   - Dimensions if not clearly shown with measurements

5. **Mark Uncertainties Clearly**:
   - If you cannot determine something from the photos, state "UNCERTAIN: [what is unclear]"
   - Only mark as uncertain if truly cannot tell from images

Be detailed and specific. Read any visible text on labels, packaging, or the product itself.`
                    },
                    ...base64Images.map(img => ({
                        type: "image_url",
                        image_url: { url: img, detail: "high" }
                    }))
                ]
            }];
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: messages,
                    max_tokens: 1500
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'OpenAI API failed');
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        async function fetchEbayPricing(analysis, manualInfo, ebayAppId) {
            // Build search query - prioritize manual input
            let searchQuery = '';
            
            // If user provided brand and model, use those
            if (manualInfo.brand && manualInfo.model) {
                searchQuery = `${manualInfo.brand} ${manualInfo.model}`.trim();
            } 
            // Otherwise send the full analysis to the function and let it extract
            else {
                searchQuery = null; // Signal that extraction is needed
            }
            
            console.log('Calling eBay pricing function...');
            
            // Call our Netlify function
            const functionUrl = '/.netlify/functions/ebay-pricing';
            
            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    searchQuery: searchQuery,
                    analysisText: analysis, // Send full GPT analysis
                    manualBrand: manualInfo.brand,
                    manualModel: manualInfo.model,
                    ebayAppId: ebayAppId
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `eBay API request failed (${response.status})`);
            }
            
            const data = await response.json();
            
            // Check if it's an error response from our function
            if (data.error) {
                throw new Error(data.message || data.error);
            }
            
            const items = data.findCompletedItemsResponse?.[0]?.searchResult?.[0]?.item || [];
            
            // Process items to include shipping
            const processedItems = items.map(item => {
                const price = parseFloat(item.sellingStatus?.[0]?.currentPrice?.[0]?.__value__ || 0);
                const shipping = parseFloat(item.shippingInfo?.[0]?.shippingServiceCost?.[0]?.__value__ || 0);
                const total = price + shipping;
                
                return {
                    title: item.title?.[0] || '',
                    price: price,
                    shipping: shipping,
                    total: total,
                    currency: item.sellingStatus?.[0]?.currentPrice?.[0]?.['@currencyId'] || 'USD',
                    endTime: item.listingInfo?.[0]?.endTime?.[0] || '',
                    condition: item.condition?.[0]?.conditionDisplayName?.[0] || 'Used'
                };
            }).filter(item => item.total > 0);
            
            console.log(`Found ${processedItems.length} eBay sold items`);
            
            return {
                searchQuery: data.searchQuery || searchQuery, // Use what the function actually searched for
                items: processedItems,
                count: processedItems.length
            };
        }
        
        function extractBrand(text) {
            const brands = ['Sony', 'Apple', 'Samsung', 'Microsoft', 'Nintendo', 'LG', 'Dell', 'HP', 'Lenovo', 'Nike', 'Adidas', 'Square', 'Canon', 'Nikon', 'Google', 'Asus', 'Acer'];
            for (const brand of brands) {
                if (text.toLowerCase().includes(brand.toLowerCase())) {
                    return brand;
                }
            }
            return '';
        }
        
        function extractModel(text) {
            // Look for model with colon or label
            const modelMatch = text.match(/(?:model|model\s*(?:no|number|#))[:\s]+([A-Z0-9\s-]+)/i);
            if (modelMatch) {
                const model = modelMatch[1].trim();
                // Clean up - stop at newline or excessive text
                return model.split('\n')[0].split(',')[0].trim();
            }
            
            // Look for model number patterns (S089, A1234, etc.)
            const patternMatch = text.match(/\b([A-Z]\d{3,4}[A-Z]?)\b/);
            if (patternMatch) return patternMatch[1];
            
            // Look for lines with "model" in them
            const lines = text.split('\n');
            for (const line of lines) {
                if (line.toLowerCase().includes('model')) {
                    // Extract alphanumeric after "model"
                    const extract = line.replace(/.*model[:\s]*/i, '').trim();
                    if (extract && extract.length < 30) {
                        return extract.split('\n')[0].split(',')[0].trim();
                    }
                }
            }
            
            return '';
        }
        
        async function generateListingWithClaude(analysis, manualInfo, ebayData, apiKey) {
            // Convert USD to CAD (approximate rate)
            const usdToCad = 1.36;
            const cadItems = ebayData.items.map(item => ({
                ...item,
                totalCAD: item.currency === 'USD' ? item.total * usdToCad : item.total
            }));
            
            const avgPrice = cadItems.length > 0 
                ? cadItems.reduce((sum, item) => sum + item.totalCAD, 0) / cadItems.length 
                : 0;
            
            const prompt = `You are an expert at creating Facebook Marketplace listings for Ottawa, Canada.

IMAGE ANALYSIS:
${analysis}

USER-PROVIDED INFORMATION:
${manualInfo.brand ? `Brand: ${manualInfo.brand}` : ''}
${manualInfo.model ? `Model: ${manualInfo.model}` : ''}
${manualInfo.year ? `Year: ${manualInfo.year}` : ''}
${manualInfo.condition ? `Condition: ${manualInfo.condition}` : 'Condition: Good working condition (assumed)'}
${manualInfo.accessories ? `Included Accessories: ${manualInfo.accessories}` : ''}
${manualInfo.dimensions ? `Dimensions: ${manualInfo.dimensions}` : ''}
${manualInfo.additional ? `Additional Notes: ${manualInfo.additional}` : ''}

EBAY PRICING DATA (Used items, all prices converted to CAD including shipping):
Found ${cadItems.length} comparable sold items:
${cadItems.slice(0, 10).map(item => 
    `- ${item.title}: $${item.totalCAD.toFixed(2)} CAD (item: $${(item.price * (item.currency === 'USD' ? usdToCad : 1)).toFixed(2)}, shipping: $${(item.shipping * (item.currency === 'USD' ? usdToCad : 1)).toFixed(2)})`
).join('\n')}
${avgPrice > 0 ? `\nAverage sold price: $${avgPrice.toFixed(2)} CAD` : ''}

CRITICAL INSTRUCTIONS:

1. ASSUME WORKING CONDITION: Unless explicitly stated otherwise, treat the product as fully functional and in good working condition. Do not flag functionality as uncertain.

2. AUTOMATIC RESEARCH: You MUST research and include the following (do not ask user):
   - Release year/model year if not provided (based on model number and any visible information)
   - Official product dimensions and weight (from manufacturer specs)
   - Original MSRP/retail price for context
   - Key specifications (storage, capacity, features, etc.)

3. ACCESSORIES: Only flag as uncertain if the user hasn't specified what's included. If user mentioned accessories, use that information.

YOUR TASKS:

1. Create SEO-optimized title (max 100 chars):
   - Brand, model, key specs
   - Condition indicator
   - Include "Ottawa" for local SEO
   - Example: "Square Stand S089 Point of Sale Terminal - Like New - Ottawa"

2. Write compelling description:
   - Brief intro sentence
   - Key features and specs in bullet points
   - Researched specifications (dimensions, year, etc.)
   - Condition details
   - What's included (based on user input or photos)
   - Why selling (if helpful for trust)
   
3. Add this EXACT disclaimer at end (with line break before):

**SERIOUS BUYERS ONLY - PLEASE READ**
This item has been carefully researched and priced fairly based on current market value. I welcome reasonable offers but will not respond to lowball offers (typically 50% or less of asking price).
**PICKUP ONLY - Near Hunt Club & Riverside intersection** If getting to this location is a problem for you, please don't inquire. No delivery available.
**Payment:** Cash or e-transfer accepted
**Communication expectations:**
* If the listing is active, the item is available - no need to ask
* Please be prepared to follow through if you inquire
* Prompt, clear communication is appreciated
* Non-responsive inquiries after initial contact will be reported as spam
Cross-posted on multiple platforms - first come, first served.
Experienced seller - these guidelines help ensure smooth transactions for serious buyers. Thank you for respecting them!

4. Pricing recommendations in CAD:
   - Low, mid, high range based on eBay sold data
   - Reasoning based on condition, completeness, and market data
   - Market insights (demand, typical time to sell, seasonal factors)
   - Include 5-10 most relevant comparable sales with prices

5. Quality checks and suggestions:
   - Photo quality assessment
   - Missing angles or information
   - Category and keyword recommendations for Facebook's algorithm
   - Any pricing concerns (too high/low compared to market)

RESPOND IN JSON:
{
  "title": "optimized title here",
  "description": "full description with disclaimer",
  "pricing": {
    "recommended_low": 150,
    "recommended_mid": 200,
    "recommended_high": 250,
    "currency": "CAD",
    "reasoning": "detailed explanation of price range",
    "market_insights": "demand analysis, typical time to sell, market trends",
    "comparables": [
      {"price": 180, "total": 195, "details": "item description and condition", "date": "2024-01-15"},
      {"price": 165, "total": 180, "details": "item description and condition", "date": "2024-01-12"}
    ]
  },
  "quality_checks": [
    {"type": "warning|success|info", "message": "specific feedback"}
  ],
  "category_suggestions": ["Primary Category", "keyword1", "keyword2"]
}`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 4096,
                    messages: [{
                        role: "user",
                        content: prompt
                    }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Anthropic API failed');
            }
            
            const data = await response.json();
            const content = data.content[0].text;
            
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('Could not parse response');
            }
            
            const listing = JSON.parse(jsonMatch[0]);
            listing.timestamp = new Date().toISOString();
            return listing;
        }
        
        function displayResults(listing) {
            document.getElementById('titleText').textContent = listing.title;
            document.getElementById('descriptionText').textContent = listing.description;
            
            // Price summary
            const priceSummary = document.getElementById('priceSummary');
            priceSummary.innerHTML = `
                <h4>üíµ Recommended Pricing</h4>
                <div class="price-range">$${listing.pricing.recommended_low} - $${listing.pricing.recommended_high} CAD</div>
                <div class="sweet-spot">Sweet Spot: $${listing.pricing.recommended_mid} CAD</div>
                <div class="price-note">${listing.pricing.reasoning}</div>
            `;
            
            // Comparables
            const comparables = document.getElementById('comparables');
            if (listing.pricing.comparables && listing.pricing.comparables.length > 0) {
                comparables.innerHTML = `
                    <h4>üìä Recent Sold Items (eBay)</h4>
                    ${listing.pricing.comparables.map(comp => `
                        <div class="comparable-item">
                            <div class="comparable-price">$${comp.total.toFixed(2)} CAD</div>
                            <div class="comparable-details">${comp.details}</div>
                        </div>
                    `).join('')}
                `;
            } else {
                comparables.innerHTML = '<p style="color: #6c757d; font-size: 14px;">No comparable sales data available</p>';
            }
            
            // Market insights
            const marketInsights = document.getElementById('marketInsights');
            marketInsights.innerHTML = `<strong>Market Insights:</strong><br>${listing.pricing.market_insights}`;
            
            // Quality checks
            const qualityDiv = document.getElementById('qualityChecks');
            const icons = { warning: '‚ö†Ô∏è', success: '‚úÖ', info: '‚ÑπÔ∏è' };
            qualityDiv.innerHTML = listing.quality_checks.map(check => `
                <div class="quality-item ${check.type}">
                    <div class="quality-icon">${icons[check.type]}</div>
                    <div class="quality-text">${check.message}</div>
                </div>
            `).join('');
            
            if (listing.category_suggestions && listing.category_suggestions.length > 0) {
                qualityDiv.innerHTML += `
                    <div class="quality-item info">
                        <div class="quality-icon">üè∑Ô∏è</div>
                        <div class="quality-text">
                            <strong>Suggested Categories/Keywords:</strong><br>
                            ${listing.category_suggestions.join(', ')}
                        </div>
                    </div>
                `;
            }
        }
        
        function copyToClipboard(elementId, event) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = original;
                    btn.classList.remove('copied');
                }, 2000);
            });
        }
        
        function startNewListing() {
            uploadedFiles = [];
            detectionResult = null;
            currentListing = null;
            userEdits = {
                brand: '',
                model: '',
                year: '',
                condition: '',
                accessories: '',
                dimensions: '',
                notes: ''
            };
            
            document.getElementById('previewGrid').innerHTML = '';
            document.getElementById('brandInput').value = '';
            document.getElementById('modelInput').value = '';
            document.getElementById('conditionInput').value = '';
            document.getElementById('additionalInfo').value = '';
            
            // Clear edit form
            document.getElementById('editBrand').value = '';
            document.getElementById('editModel').value = '';
            document.getElementById('editYear').value = '';
            document.getElementById('editCondition').value = '';
            document.getElementById('editAccessories').value = '';
            document.getElementById('editDimensions').value = '';
            document.getElementById('editNotes').value = '';
            
            document.getElementById('reviewSection').classList.remove('active');
            document.getElementById('resultsSection').classList.remove('active');
            document.getElementById('mainContent').style.display = 'block';
            updateAnalyzeButton();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function saveToHistory(listing) {
            const history = JSON.parse(localStorage.getItem('listing_history') || '[]');
            history.unshift({
                title: listing.title,
                price: listing.pricing.recommended_mid,
                timestamp: listing.timestamp,
                full: listing
            });
            
            // Keep only last 50
            if (history.length > 50) {
                history.pop();
            }
            
            localStorage.setItem('listing_history', JSON.stringify(history));
        }
        
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('listing_history') || '[]');
            const listDiv = document.getElementById('historyList');
            
            if (history.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-history">
                        <div class="icon">üìã</div>
                        <p>No listings yet</p>
                    </div>
                `;
                return;
            }
            
            listDiv.innerHTML = history.map((item, index) => {
                const date = new Date(item.timestamp);
                return `
                    <div class="history-item" onclick="viewHistoryItem(${index})">
                        <div class="history-title">${item.title}</div>
                        <div class="history-date">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                        <div class="history-price">$${item.price} CAD</div>
                    </div>
                `;
            }).join('');
        }
        
        function viewHistoryItem(index) {
            const history = JSON.parse(localStorage.getItem('listing_history') || '[]');
            const item = history[index];
            
            if (item && item.full) {
                currentListing = item.full;
                displayResults(currentListing);
                document.getElementById('resultsSection').classList.add('active');
                document.getElementById('mainContent').style.display = 'none';
                closeHistory();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function openHistory() {
            loadHistory();
            document.getElementById('historyModal').classList.add('active');
        }
        
        function closeHistory() {
            document.getElementById('historyModal').classList.remove('active');
        }
        
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => {
                console.log('Service worker registration failed:', err);
            });
        }
    </script>
</body>
</html>